# Codebase Structure

## Directory Layout
```
PR-Bot/
├── src/                      # TypeScript source code
│   ├── db/                   # Database layer
│   │   ├── database.ts       # SQLite initialization & schema
│   │   ├── queries.ts        # PR messages & global user mappings queries
│   │   └── team-config.ts    # Multi-team configuration CRUD
│   ├── github/               # GitHub integration
│   │   ├── client.ts         # Octokit client initialization
│   │   ├── pr-service.ts     # Fetch PR data from GitHub API
│   │   └── webhook-handler.ts # Process GitHub webhook events
│   ├── slack/                # Slack integration
│   │   ├── app-home.ts       # Build App Home UI views
│   │   ├── app-home-handlers.ts # Handle App Home interactions
│   │   ├── commands.ts       # Slash command handlers
│   │   ├── message-service.ts # Post/update Slack messages
│   │   ├── messages.ts       # Format PR data into Slack Block Kit
│   │   └── user-mapping.ts   # Resolve GitHub → Slack user mentions
│   ├── utils/                # Utilities
│   │   ├── logger.ts         # Simple console logger
│   │   └── retry.ts          # Retry logic for API calls
│   ├── config.ts             # Load and validate environment variables
│   ├── types.ts              # TypeScript interfaces and types
│   ├── index.ts              # Main entry point
│   └── demo.ts               # Demo/test script (legacy)
├── dist/                     # Compiled JavaScript (generated by tsc)
├── data/                     # SQLite database file (gitignored)
├── .env                      # Environment variables (gitignored)
├── .github/                  # GitHub workflows (if any)
├── docs/                     # Additional documentation
├── DATABASE-DESIGN.md        # Database schema documentation
├── README.md                 # Main documentation
├── SLACK-SETUP.md            # Slack app setup guide
├── package.json              # Node.js dependencies and scripts
└── tsconfig.json             # TypeScript configuration
```

## Key Files

### Entry Point
- **src/index.ts**: Main application entry point
  - Initializes database
  - Sets up Express server for webhooks
  - Registers Slack Bolt app handlers
  - Starts server on configured port

### Database Layer
- **src/db/database.ts**: Schema creation and initialization
- **src/db/team-config.ts**: Multi-team CRUD operations
- **src/db/queries.ts**: PR message tracking and user mappings

### GitHub Integration
- **src/github/webhook-handler.ts**: Processes PR events (opened, reviewed, merged, etc.)
- **src/github/pr-service.ts**: Fetches PR details from GitHub API
- **src/github/client.ts**: Octokit REST client singleton

### Slack Integration
- **src/slack/app-home-handlers.ts**: App Home button/modal handlers (add members, repos, settings)
- **src/slack/message-service.ts**: Post new messages or update existing ones
- **src/slack/messages.ts**: Format PR data into Slack Block Kit JSON
- **src/slack/user-mapping.ts**: Resolve GitHub usernames to Slack user IDs for @mentions

### Configuration
- **src/config.ts**: Loads .env and validates required variables
- **src/types.ts**: All TypeScript interfaces (AppConfig, PRData, TeamConfig, etc.)

## Data Flow

### Webhook Flow
1. GitHub sends webhook to `/github/webhook`
2. `webhook-handler.ts` validates signature and extracts PR data
3. `pr-service.ts` fetches full PR details from GitHub API
4. `team-config.ts` finds channels tracking the PR author + repo
5. `messages.ts` formats PR data into Slack Block Kit
6. `message-service.ts` posts/updates message in Slack
7. `queries.ts` saves message timestamp for future updates

### App Home Flow
1. User opens App Home tab in Slack
2. Slack sends `app_home_opened` event to `/slack/events`
3. `app-home-handlers.ts` handles event
4. `app-home.ts` builds UI based on team config from database
5. User clicks button → modal opens → user submits form
6. Handler saves to database via `team-config.ts`
7. App Home refreshes to show updated config
